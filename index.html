<!doctype html>
<html>
  <head>
    <title>YouTube 轉換器</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      body {
        font-family: "Noto Sans TC", system-ui, sans-serif;
        padding: 1em;
      }
      input,
      button,
      textarea {
        width: 100%;
        font-size: 1rem;
        margin-top: 0.5em;
      }
      .result-block {
        display: flex;
        align-items: center;
        flex-wrap: wrap;
        margin-top: 1em;
      }
      label {
        font-weight: bold;
      }
      a {
        color: blue;
        text-decoration: underline;
      }
      textarea {
        width: 100%;
		flex-basis: 100%;
        margin-top: 0.2em;
		resize: none; /* 隱藏右下角調整手柄，看起來更像 input */
		overflow: hidden; /* 防止出現滾動條影響視覺 */
      }
      .hidden {
        display: none !important;
      }
    </style>
  </head>
  <body>
    <h2>YouTube 轉換器</h2>
    <div class="result-block">
      <label>請貼上 YouTube/YouTube Music 連結：</label>
      <input id="yt" placeholder="https://www.youtube.com/watch?v=jNQXAC9IVRw" />
      <button onclick="convert()">轉換</button>
    </div>

    <div id="results"></div>

    <hr />
    <div class="result-block">
      <p><strong>切換其他版本：</strong></p>
      <ul>
        <li><a href="index0.html">index0.html（只支援影片，相容舊瀏覽器）</a></li>
        <li><a href="index.html">index.html（功能完整但相容性較低）</a></li>
        <li><a href="index-legacy.html">index-legacy.html（功能完整，相容舊瀏覽器）</a></li>
      </ul>
    </div>

    <script>
      // 定義服務列表 (簡化版設定)
      const services = [
        { id: "youtube", label: "youtube", base: "https://yout-ube.com/", type: "watch" },
        { id: "Invidious", label: "Invidious", base: "https://inv.nadeko.net/", type: "watch" },
		{ id: "InvidiousUA", label: "Invidious", base: "https://invidious.nerdvpn.de/", type: "watch" },
		{ id: "InvidiousDE", label: "Invidious", base: "https://yewtu.be/", type: "watch" },
        { id: "PrivatecoffeePiped", label: "Piped", base: "https://piped.private.coffee/", type: "watch" },
        { id: "wirewaychPiped", label: "Piped", base: "https://piped.wireway.ch/", type: "watch" },
        { id: "NYCPiped", label: "Piped (NYC)", base: "https://nyc1.pi.ggtyler.dev/", type: "watch", hidden: true },
        { id: "CALPiped", label: "Piped (CAL)", base: "https://cal1.pi.ggtyler.dev/", type: "watch", hidden: true },
        { id: "POLPiped", label: "Piped (POL)", base: "https://pol1.pi.ggtyler.dev/", type: "watch", hidden: true },
        { id: "wirewaychRePiped", label: "RePiped", base: "https://repiped.wireway.ch/video.html?v=", mode: "vid" },
        { id: "wirewaychdevRePiped", label: "RePiped", base: "https://repiped-development-c7df8a.onwireway.online/video.html?v=", mode: "vid" },
        { id: "duckspartyHyperpipe", label: "Hyperpipe", base: "https://hyperpipe.ducks.party/", type: "watch", hidden: true, isMusic: true },
        { id: "NYCHyperpipe", label: "Hyperpipe (NYC)", base: "https://nyc1.hp.ggtyler.dev/", type: "watch", hidden: true, isMusic: true },
        { id: "CALHyperpipe", label: "Hyperpipe (CAL)", base: "https://cal1.hp.ggtyler.dev/", type: "watch", hidden: true, isMusic: true },
        { id: "POLHyperpipe", label: "Hyperpipe (POL)", base: "https://pol1.hp.ggtyler.dev/", type: "watch", hidden: true, isMusic: true },
        { id: "ytify", label: "ytify", base: "https://ytify.pp.ua/", mode: "ytify", isMusic: true },
        { id: "cinemaphile.com", label: "cinemaphile.com", base: "https://cinemaphile.com/", type: "watch", noList: true },
        { id: "YMusic", label: "YMusic", base: "https://ymusicapp.com/", type: "watch" },
        { id: "m.gjhyss.com", label: "m.gjhyss.com", base: "https://m.gjhyss.com/share?v=", mode: "vid" },
        { id: "AstroTube", label: "AstroTube", base: "https://at.ggtyler.dev/watch?v=", mode: "vid", hidden: true },
        { id: "shorturl", label: "最短 YouTube", base: "https://youtu.be/", mode: "short" },
        { id: "YTMusic", label: "YouTube Music", base: "https://music.youtube.com/", type: "watch", isMusic: true },
      ];

      // 初始化 HTML
      document.getElementById("results").innerHTML = services
        .map(
          (s) => `
      <div class="result-block ${s.hidden ? "hidden" : ""}">
        <label>${s.label} 分享網址：</label>
        <a id="link_${s.id}" href="#" target="_blank" class="hidden">點我前往${s.isMusic ? "音樂" : "影片"}</a>
        <textarea id="val_${s.id}" rows="1" readonly></textarea>
      </div>
    `
        )
        .join("");

      const convert = () => {
        const input = document.getElementById("yt").value.trim();
        let vid, list;

        try {
          const urlObj = new URL(input, "https://youtube.com");
          if (urlObj.hostname === "youtu.be") {
            vid = urlObj.pathname.slice(1);
            list = urlObj.searchParams.get("list");
          } else {
            vid = urlObj.searchParams.get("v") || input.match(/(?:v=|\/)([0-9A-Za-z_-]{11})/)?.[1];
            list = urlObj.searchParams.get("list");
          }
          // 特殊修正：如果 vid 是 playlist 字眼，那是誤判
          if (vid === "playlist") vid = null;
        } catch {
          /* 忽略 URL 解析錯誤 */
        }

        if (!vid && !list) {
          services.forEach((s) => {
            document.getElementById(`val_${s.id}`).value = "⚠️ 無法辨識影片或播放清單 ID";
            document.getElementById(`link_${s.id}`).classList.add("hidden");
          });
          return;
        }

        // 定義只支援 Playlist 的服務 (Hyperpipe 家族)
        const playlistOnlyServices = ["duckspartyHyperpipe", "NYCHyperpipe", "CALHyperpipe", "POLHyperpipe"];

        services.forEach((s) => {
          let url = null;
          const { base, type, mode, id, noList } = s;

          if (mode === "short") {
            if (vid && list) url = `${base}${vid}?list=${list}`;
            else if (vid) url = `${base}${vid}`;
            else if (list) url = `https://youtube.com/playlist?list=${list}`;
          } else if (mode === "ytify") {
            url = list ? `${base}list?playlists=${list}` : vid ? `${base}?s=${vid}` : null;
          } else if (mode === "vid") {
            url = vid ? `${base}${vid}` : null;
          } else {
            // mode: "auto" (default)
            if (vid && list) {
              if (playlistOnlyServices.includes(id)) url = `${base}playlist?list=${list}`;
              else if (noList)
                url = `${base}${type}?v=${vid}`; // cinemaphile
              else url = `${base}${type}?v=${vid}&list=${list}`;
            } else if (vid) {
              url = `${base}${type}?v=${vid}`;
            } else if (list) {
              if (id === "youtube" || noList)
                url = null; // 排除 youtube/cinemaphile
              else url = `${base}playlist?list=${list}`;
            }
          }

          const inputEl = document.getElementById(`val_${id}`);
          const linkEl = document.getElementById(`link_${id}`);

          if (url) {
            inputEl.value = url;
            linkEl.href = url;
            linkEl.textContent = url;
            linkEl.classList.remove("hidden");
          } else {
            inputEl.value = "⚠️ 無法產生連結";
            linkEl.classList.add("hidden");
          }
        });
      };
    </script>
  </body>
</html>
